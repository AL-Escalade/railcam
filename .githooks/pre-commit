#!/bin/bash
# Pre-commit hook: ensure LFS-tracked patterns are committed as LFS pointers

set -e

# Get staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$staged_files" ]; then
    exit 0
fi

errors=0

for file in $staged_files; do
    # Check if file matches an LFS pattern
    filter=$(git check-attr filter -- "$file" | sed 's/.*: //')

    if [ "$filter" = "lfs" ]; then
        # File should be LFS - verify it's a pointer, not binary
        staged_content=$(git cat-file blob ":$file" 2>/dev/null | head -c 100)

        if [[ ! "$staged_content" =~ ^version\ https://git-lfs ]]; then
            echo "ERROR: '$file' matches LFS pattern but is not an LFS pointer."
            echo "       Run: git rm --cached \"$file\" && git add \"$file\""
            errors=1
        fi
    fi
done

if [ $errors -ne 0 ]; then
    echo ""
    echo "Commit aborted. Fix LFS issues above and retry."
    exit 1
fi

exit 0
